{% extends "base.html" %}

{% block title %}Options Strategy Calculator{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="text-center mb-12 fade-in">
        <h1 class="text-4xl font-extrabold text-white">Options Strategy Calculator</h1>
        <p class="text-gray-400 mt-2">Analyze trades with our options calculation tools.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-gray-800/50 p-8 rounded-2xl fade-in">
            <h2 class="text-2xl font-bold text-white mb-2">Market's Expected Move</h2>
            <p class="text-gray-500 mb-6">Calculate the price swing the market expects, based on ATM straddle prices.</p>
            <form method="POST">
                <input type="hidden" name="calculation_type" value="expected_move">
                <div class="space-y-4">
                    <div>
                        <label for="stock_price_move" class="flex items-center text-sm font-medium text-gray-400">
                            Current Stock Price (€)
                            <span class="tooltip ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-gray-500" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.293-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 9.58l-.205-1.022L8.93 6.588zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltiptext">The current market price of the underlying stock. This is the base price for options contracts.</span>
                            </span>
                        </label>
                        <input type="number" name="stock_price_move" value="{{ form_data.stock_price_move | default(150) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="call_price_move" class="flex items-center text-sm font-medium text-gray-400">
                            ATM Call Option Price (€)
                            <span class="tooltip ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-gray-500" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.293-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 9.58l-.205-1.022L8.93 6.588zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltiptext">The price (premium) of a call option with a strike price very close to the current stock price (At-The-Money or ATM). Used in straddle calculations for expected move.</span>
                            </span>
                        </label>
                        <input type="number" name="call_price_move" value="{{ form_data.call_price_move | default(5) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="put_price_move" class="flex items-center text-sm font-medium text-gray-400">
                            ATM Put Option Price (€)
                            <span class="tooltip ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-gray-500" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.293-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 9.58l-.205-1.022L8.93 6.588zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltiptext">The price (premium) of a put option with a strike price very close to the current stock price (At-The-Money or ATM). Used in straddle calculations for expected move.</span>
                            </span>
                        </label>
                        <input type="number" name="put_price_move" value="{{ form_data.put_price_move | default(5) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 no-tap-highlight">Calculate Move</button>
            </form>
             {% if result and result.type == 'expected_move' %}
                {% if result.error %}
                     <div class="mt-6 bg-red-900/50 border border-red-500/30 text-red-300 p-4 rounded-lg" role="alert">
                        <p class="font-bold">Error</p><p>{{ result.error }}</p>
                    </div>
                {% else %}
                <div class="mt-6 bg-gray-900/50 p-6 rounded-lg">
                    <h3 class="font-semibold text-white mb-4">Expected Move Analysis</h3>
                    <div class="text-center">
                        <p class="text-gray-400">Expected Move (up or down):</p>
                        <p class="text-3xl font-bold text-indigo-400 my-1">€{{ "{:,.2f}".format(result.expected_move) }}</p>
                        <p class="text-gray-500 text-sm">({{ "{:.2%}".format(result.expected_percentage) }})</p>
                    </div>
                    <hr class="my-4 border-gray-700/50">
                    <div class="text-sm text-center text-gray-400">
                        <p>Implied Trading Range:</p>
                        <p class="font-medium text-gray-200">€{{ "{:,.2f}".format(result.lower_bound) }} – €{{ "{:,.2f}".format(result.upper_bound) }}</p>
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>

        <div class="bg-gray-800/50 p-8 rounded-2xl fade-in-delay">
            <h2 class="text-2xl font-bold text-white mb-2">Sell vs. Exercise</h2>
            <p class="text-gray-500 mb-6">Compare the profit from selling an option versus exercising it to see why selling is almost always better.</p>
            <form method="POST">
                <input type="hidden" name="calculation_type" value="sell_vs_exercise">
                <div class="space-y-4">
                    <div>
                        <label for="stock_price_exercise" class="flex items-center text-sm font-medium text-gray-400">
                            Current Stock Price (€)
                            <span class="tooltip ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-gray-500" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.293-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 9.58l-.205-1.022L8.93 6.588zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltiptext">The current market price of the underlying stock. This is the price at which you could buy or sell shares immediately.</span>
                            </span>
                        </label>
                        <input type="number" name="stock_price_exercise" value="{{ form_data.stock_price_exercise | default(165) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="strike_price_exercise" class="flex items-center text-sm font-medium text-gray-400">
                            Option Strike Price (€)
                            <span class="tooltip ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-gray-500" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.293-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 9.58l-.205-1.022L8.93 6.588zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltiptext">The predetermined price at which an option contract can be exercised. For call options, if the stock price is above this, it's 'in-the-money'.</span>
                            </span>
                        </label>
                        <input type="number" name="strike_price_exercise" value="{{ form_data.strike_price_exercise | default(155) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="premium_exercise" class="flex items-center text-sm font-medium text-gray-400">
                            Option Premium (€)
                            <span class="tooltip ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-gray-500" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.293-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 9.58l-.205-1.022L8.93 6.588zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltiptext">The market price of the option contract itself. This includes both intrinsic and extrinsic (time/volatility) value.</span>
                            </span>
                        </label>
                        <input type="number" name="premium_exercise" value="{{ form_data.premium_exercise | default(10.50) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 no-tap-highlight">Compare Profits</button>
            </form>
             {% if result and result.type == 'sell_vs_exercise' %}
                 {% if result.error %}
                     <div class="mt-6 bg-red-900/50 border border-red-500/30 text-red-300 p-4 rounded-lg" role="alert">
                        <p class="font-bold">Error</p><p>{{ result.error }}</p>
                    </div>
                 {% elif result.note %}
                     <div class="mt-6 bg-blue-900/50 border border-blue-500/30 text-blue-300 p-4 rounded-lg" role="alert">
                        <p class="font-bold">Note</p><p>{{ result.note }}</p>
                    </div>
                {% else %}
                <div class="mt-6 bg-gray-900/50 p-6 rounded-lg">
                    <h3 class="font-semibold text-white mb-4">Profit Comparison (per share)</h3>
                     <div class="space-y-3">
                        <div class="flex justify-between items-baseline">
                            <p class="text-gray-400">Profit from Selling:</p>
                            <p class="text-lg font-bold text-green-400">€{{ "{:,.2f}".format(result.profit_from_selling) }}</p>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <p class="text-gray-400">Profit from Exercising:</p>
                            <p class="text-lg font-medium text-gray-200">€{{ "{:,.2f}".format(result.profit_from_exercising) }}</p>
                        </div>
                    </div>
                    <hr class="my-4 border-gray-700/50">
                    <div class="text-center">
                        <p class="text-gray-400">Extra profit by selling:</p>
                        <p class="text-2xl font-bold text-indigo-400">€{{ "{:,.2f}".format(result.extrinsic_value) }}</p>
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    <div class="mt-8 bg-gray-800/50 p-8 rounded-2xl fade-in-delay">
        <h2 class="text-2xl font-bold text-white mb-2">Option Pricing Model</h2>
        <p class="text-gray-500 mb-6">Calculate the theoretical price of an option using industry-standard models.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <form method="POST">
                    <input type="hidden" name="calculation_type" value="black_scholes">
                    <div class="space-y-4">
                         <div>
                            <label for="style_bs" class="block text-sm font-medium text-gray-400">Option Style</label>
                            <select name="style_bs" id="style_bs" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="european" {% if form_data.style_bs == 'european' %}selected{% endif %}>European (Black-Scholes)</option>
                                <option value="american" {% if form_data.style_bs == 'american' %}selected{% endif %}>American (Binomial Tree)</option>
                            </select>
                        </div>
                        <div>
                            <label for="option_type_bs" class="block text-sm font-medium text-gray-400">Option Type</label>
                            <select name="option_type_bs" id="option_type_bs" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="call" {% if form_data.option_type_bs == 'call' %}selected{% endif %}>Call</option>
                                <option value="put" {% if form_data.option_type_bs == 'put' %}selected{% endif %}>Put</option>
                            </select>
                        </div>
                        <div>
                            <label for="s_bs" class="flex items-center text-sm font-medium text-gray-400">Stock Price (€)</label>
                            <input type="number" name="s_bs" value="{{ form_data.s_bs | default(100) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="k_bs" class="flex items-center text-sm font-medium text-gray-400">Strike Price (€)</label>
                            <input type="number" name="k_bs" value="{{ form_data.k_bs | default(100) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="t_bs" class="flex items-center text-sm font-medium text-gray-400">Time to Expiration (Days)</label>
                            <input type="number" name="t_bs" value="{{ form_data.t_bs | default(90) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="r_bs" class="flex items-center text-sm font-medium text-gray-400">Risk-Free Rate (%)</label>
                            <input type="number" name="r_bs" value="{{ form_data.r_bs | default(5) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="sigma_bs" class="flex items-center text-sm font-medium text-gray-400">Volatility (%)</label>
                            <input type="number" name="sigma_bs" value="{{ form_data.sigma_bs | default(20) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="market_premium_bs" class="flex items-center text-sm font-medium text-gray-400">Market Premium (€) (Optional)</label>
                            <input type="number" name="market_premium_bs" value="{{ form_data.market_premium_bs | default(5.0) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 no-tap-highlight">Calculate Price</button>
                </form>
            </div>
            <div>
            {% if result and result.type == 'black_scholes' %}
                {% if result.error %}
                    <div class="bg-red-900/50 border border-red-500/30 text-red-300 p-4 rounded-lg h-full flex flex-col justify-center" role="alert">
                        <p class="font-bold">Error</p>
                        <p>{{ result.error }}</p>
                    </div>
                {% else %}
                    <div class="bg-gray-900/50 p-6 rounded-lg h-full">
                        <h3 class="text-xl font-semibold text-white mb-4 text-center">Theoretical Option Price</h3>
                        <p class="text-5xl font-bold text-indigo-400 text-center">€{{ "{:,.2f}".format(result.price) }}</p>
                        {% if result.valuation %}
                        <div class="mt-4 text-center">
                            <p class="text-lg font-semibold {% if result.valuation == 'Overvalued' %}text-red-400{% else %}text-green-400{% endif %}">{{ result.valuation }}</p>
                            <p class="text-gray-400">by €{{ "{:,.2f}".format(result.difference) }}</p>
                        </div>
                        {% endif %}
                        {% if result.greeks %}
                        <div class="mt-6">
                            <h4 class="font-semibold text-white mb-2 text-center">Option Greeks</h4>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Delta:</span> <span class="font-mono text-gray-200">{{ "%.4f"|format(result.greeks.delta) }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Gamma:</span> <span class="font-mono text-gray-200">{{ "%.4f"|format(result.greeks.gamma) }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Theta:</span> <span class="font-mono text-gray-200">{{ "%.4f"|format(result.greeks.theta) }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Vega:</span> <span class="font-mono text-gray-200">{{ "%.4f"|format(result.greeks.vega) }}</span></div>
                                <div class="flex justify-between col-span-2"><span class="text-gray-400">Rho:</span> <span class="font-mono text-gray-200">{{ "%.4f"|format(result.greeks.rho) }}</span></div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <canvas id="plChart"></canvas>
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
             {% else %}
                <div class="bg-gray-900/50 p-6 rounded-lg h-full flex flex-col justify-center text-center">
                     <h3 class="text-xl font-semibold text-white">Your results will appear here</h3>
                    <p class="text-gray-500 mt-2">Fill out the form to calculate the theoretical option price.</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>
    <div class="mt-8 bg-gray-800/50 p-8 rounded-2xl fade-in-delay">
        <h2 class="text-2xl font-bold text-white mb-2">Implied Volatility Calculator</h2>
        <p class="text-gray-500 mb-6">Work backward from the market price to find the implied volatility (IV).</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <form method="POST">
                    <input type="hidden" name="calculation_type" value="implied_volatility">
                    <div class="space-y-4">
                        <div>
                            <label for="option_type_iv" class="block text-sm font-medium text-gray-400">Option Type</label>
                            <select name="option_type_iv" id="option_type_iv" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="call" {% if form_data.option_type_iv == 'call' %}selected{% endif %}>Call</option>
                                <option value="put" {% if form_data.option_type_iv == 'put' %}selected{% endif %}>Put</option>
                            </select>
                        </div>
                        <div>
                            <label for="s_iv" class="flex items-center text-sm font-medium text-gray-400">Stock Price (€)</label>
                            <input type="number" name="s_iv" value="{{ form_data.s_iv | default(100) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="k_iv" class="flex items-center text-sm font-medium text-gray-400">Strike Price (€)</label>
                            <input type="number" name="k_iv" value="{{ form_data.k_iv | default(100) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                         <div>
                            <label for="t_iv" class="flex items-center text-sm font-medium text-gray-400">Time to Expiration (Days)</label>
                            <input type="number" name="t_iv" value="{{ form_data.t_iv | default(90) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="r_iv" class="flex items-center text-sm font-medium text-gray-400">Risk-Free Rate (%)</label>
                            <input type="number" name="r_iv" value="{{ form_data.r_iv | default(5) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="market_premium_iv" class="flex items-center text-sm font-medium text-gray-400">Market Premium (€)</label>
                            <input type="number" name="market_premium_iv" value="{{ form_data.market_premium_iv | default(5.0) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                    </div>
                    <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 no-tap-highlight">Calculate IV</button>
                </form>
            </div>
             <div>
            {% if result and result.type == 'implied_volatility' %}
                {% if result.error %}
                    <div class="bg-red-900/50 border border-red-500/30 text-red-300 p-4 rounded-lg h-full flex flex-col justify-center" role="alert">
                        <p class="font-bold">Error</p>
                        <p>{{ result.error }}</p>
                    </div>
                {% else %}
                    <div class="bg-gray-900/50 p-6 rounded-lg h-full flex flex-col justify-center text-center">
                        <h3 class="text-xl font-semibold text-white mb-4">Implied Volatility (IV)</h3>
                        <p class="text-5xl font-bold text-indigo-400">{{ "{:.2%}".format(result.implied_volatility) }}</p>
                    </div>
                {% endif %}
             {% else %}
                <div class="bg-gray-900/50 p-6 rounded-lg h-full flex flex-col justify-center text-center">
                     <h3 class="text-xl font-semibold text-white">Your IV result will appear here</h3>
                    <p class="text-gray-500 mt-2">Fill out the form to calculate the implied volatility.</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>
    <div class="mt-8 bg-gray-800/50 p-8 rounded-2xl fade-in-delay">
        <h2 class="text-2xl font-bold text-white mb-2">Advanced P/L Breakeven</h2>
        <p class="text-gray-500 mb-6">Calculate the breakeven stock movement for an options trade and see a summary plot.</p>
         <div class="text-sm p-4 mb-6 bg-gray-900/50 rounded-lg border border-gray-700/50 text-gray-400">
            <strong>Note:</strong> This calculation assumes that Gamma and Vega remain constant over the holding period, which is an approximation. For longer holding periods or large moves in the underlying, these values will change.
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <form method="POST">
                    <input type="hidden" name="calculation_type" value="advanced_breakeven">
                    <div class="space-y-4">
                        <div>
                            <label for="option_type_adv" class="block text-sm font-medium text-gray-400">Option Type</label>
                            <select name="option_type_adv" id="option_type_adv" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="call" {% if form_data.option_type_adv == 'call' %}selected{% endif %}>Call</option>
                                <option value="put" {% if form_data.option_type_adv == 'put' %}selected{% endif %}>Put</option>
                            </select>
                        </div>
                        <div>
                            <label for="current_stock_price_adv" class="flex items-center text-sm font-medium text-gray-400">
                                Current Stock Price (€)
                            </label>
                            <input type="number" name="current_stock_price_adv" value="{{ form_data.current_stock_price_adv | default(100) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="delta_adv" class="flex items-center text-sm font-medium text-gray-400">
                                Delta
                            </label>
                            <input type="number" name="delta_adv" value="{{ form_data.delta_adv | default(0.5) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="gamma_adv" class="flex items-center text-sm font-medium text-gray-400">
                                Gamma
                            </label>
                            <input type="number" name="gamma_adv" value="{{ form_data.gamma_adv | default(0.08) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="theta_adv" class="flex items-center text-sm font-medium text-gray-400">
                                Theta
                            </label>
                            <input type="number" name="theta_adv" value="{{ form_data.theta_adv | default(-0.05) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="vega_adv" class="flex items-center text-sm font-medium text-gray-400">
                                Vega
                            </label>
                            <input type="number" name="vega_adv" value="{{ form_data.vega_adv | default(0.12) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="bid_ask_spread_adv" class="flex items-center text-sm font-medium text-gray-400">
                                Bid-Ask Spread (€)
                            </label>
                            <input type="number" name="bid_ask_spread_adv" value="{{ form_data.bid_ask_spread_adv | default(0.05) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="expected_iv_change_adv" class="flex items-center text-sm font-medium text-gray-400">
                                Expected IV Change (%)
                            </label>
                            <input type="number" name="expected_iv_change_adv" value="{{ form_data.expected_iv_change_adv | default(-2) }}" step="any" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="days_to_hold_adv" class="flex items-center text-sm font-medium text-gray-400">
                                Days to Hold
                            </label>
                            <input type="number" name="days_to_hold_adv" value="{{ form_data.days_to_hold_adv | default(10) }}" step="1" class="mt-1 block w-full px-3 py-2 bg-gray-800 border-none rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                    </div>
                    <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 no-tap-highlight">Calculate Breakeven</button>
                </form>
            </div>
            <div>
            {% if result and result.type == 'advanced_breakeven' %}
                {% if result.error %}
                    <div class="bg-red-900/50 border border-red-500/30 text-red-300 p-4 rounded-lg h-full flex flex-col justify-center" role="alert">
                        <p class="font-bold">Error</p>
                        <p>{{ result.error }}</p>
                    </div>
                {% else %}
                    <div class="bg-gray-900/50 p-6 rounded-lg h-full">
                        <h3 class="text-xl font-semibold text-white mb-4 text-center">Breakeven Analysis</h3>
                        <div class="text-center">
                             <p class="text-gray-400">Required Stock Price Move:</p>
                             <p class="text-4xl font-bold text-indigo-400 my-1">€{{ "{:,.2f}".format(result.required_move) }}</p>
                             <p class="text-gray-500 text-lg">({{ "{:,.2f}".format(result.percent_move) }}%)</p>
                        </div>
                         <hr class="my-4 border-gray-700/50">
                         <div class="text-center mb-4">
                            <p class="text-gray-400">Target Stock Price:</p>
                            <p class="text-3xl font-bold text-gray-200">€{{ "{:,.2f}".format(result.target_price) }}</p>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Time Decay (Theta) Cost:</span>
                                <span class="font-medium text-red-400">€{{ "{:,.2f}".format(result.total_theta_decay) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">IV Change (Vega) Impact:</span>
                                <span class="font-medium {% if result.total_vega_impact >= 0 %}text-green-400{% else %}text-red-400{% endif %}">€{{ "{:,.2f}".format(result.total_vega_impact) }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Bid-Ask Spread Cost:</span>
                                <span class="font-medium text-red-400">€{{ "{:,.2f}".format(result.bid_ask_spread_cost) }}</span>
                            </div>
                            <hr class="my-2 border-gray-700/50">
                            <div class="flex justify-between font-bold">
                                <span class="text-gray-300">Total Headwind:</span>
                                <span class="text-white">€{{ "{:,.2f}".format(result.total_headwind) }}</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            <canvas id="breakevenChart"></canvas>
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div class="bg-gray-900/50 p-6 rounded-lg h-full flex flex-col justify-center text-center">
                     <h3 class="text-xl font-semibold text-white">Your results will appear here</h3>
                    <p class="text-gray-500 mt-2">Fill out the form to calculate your breakeven price.</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>

    <div class="mt-8 bg-gray-800/50 p-8 rounded-2xl fade-in-delay">
        <h2 class="text-2xl font-bold text-white mb-4">How It's Calculated</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h3 class="text-xl font-semibold text-white mb-2">Market's Expected Move</h3>
                <p class="text-gray-400">The expected move is calculated by adding the prices of the at-the-money (ATM) call and put options. This sum, known as an <strong class="text-white">ATM Straddle</strong>, estimates the range the market anticipates the underlying asset will move by the option's expiration.</p>
                <div class="mt-4 p-4 bg-gray-900/50 rounded-lg text-white font-mono text-sm overflow-x-auto">
                    $$\text{Expected Move} = \text{ATM Call Price} + \text{ATM Put Price}$$
                </div>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-white mb-2">Sell vs. Exercise</h3>
                <p class="text-gray-400">The profit from selling is the option's premium, while the profit from exercising is its intrinsic value. <strong class="text-white">Selling an option often yields more profit</strong> because you capture the extrinsic value (time value and implied volatility) that is lost when an option is exercised.</p>
                <div class="mt-4 p-4 bg-gray-900/50 rounded-lg text-white font-mono text-sm overflow-x-auto">
                    $$\text{Profit from Selling} = \text{Option Premium}$$
                    $$\text{Profit from Exercising} = \text{Stock Price} - \text{Strike Price}$$
                </div>
            </div>
            <div class="md:col-span-2">
                <h3 class="text-xl font-semibold text-white mb-2">Black-Scholes Model</h3>
                <p class="text-gray-400">The Black-Scholes formula is used to calculate the theoretical price of European-style options. It considers the stock price, strike price, time to expiration, risk-free rate, and volatility.</p>
                <div class="mt-4 p-4 bg-gray-900/50 rounded-lg text-white font-mono text-sm overflow-x-auto">
                    $$ C(S, t) = N(d_1)S - N(d_2)Ke^{-r(T-t)} $$
                    $$ P(S, t) = N(-d_2)Ke^{-r(T-t)} - N(-d_1)S $$
                </div>
            </div>
            <div class="md:col-span-2">
                <h3 class="text-xl font-semibold text-white mb-2">Advanced Breakeven</h3>
                <p class="text-gray-400">The advanced breakeven is calculated using a second-order Taylor expansion of the option's price, incorporating the Greeks to model the change in value.</p>
                <div class="mt-4 p-4 bg-gray-900/50 rounded-lg text-white font-mono text-sm overflow-x-auto">
                    $$ \Delta P \approx \Delta S \cdot \frac{\partial P}{\partial S} + \frac{1}{2} (\Delta S)^2 \cdot \frac{\partial^2 P}{\partial S^2} $$
                    $$ \text{Total Headwind} = \text{Theta} + \text{Vega} + \text{Spread} $$
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const breakevenChartDataJson = '{{ result.chart_data | tojson | safe if result and result.type == "advanced_breakeven" and result.chart_data else "" }}';
        const plChartDataJson = '{{ result.pl_chart_data | tojson | safe if result and result.type == "black_scholes" and result.pl_chart_data else "" }}';

        if (breakevenChartDataJson) {
            try {
                const chartData = JSON.parse(breakevenChartDataJson);
                const ctx = document.getElementById('breakevenChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Required Stock Movement vs. Holding Period', color: '#e0e0e0', font: { size: 16 } },
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('de-DE', { style: 'percent', minimumFractionDigits: 2 }).format(context.parsed.y / 100);
                                        }
                                        return label;
                                    },
                                    title: function(context) { return 'Holding Period: ' + context[0].label + ' days'; }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af' }, title: { display: true, text: 'Holding Period (Days)', color: '#9ca3af' } },
                            y: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af', callback: function(value) { return new Intl.NumberFormat('de-DE', { style: 'percent', minimumFractionDigits: 0 }).format(value / 100); } }, title: { display: true, text: 'Required Stock Movement (%)', color: '#9ca3af' } }
                        }
                    }
                });
            } catch (e) {
                console.error("Failed to parse breakeven chart data:", e);
            }
        }

        if (plChartDataJson) {
            try {
                const chartData = JSON.parse(plChartDataJson);
                const ctx = document.getElementById('plChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'Profit/Loss at Expiration', color: '#e0e0e0', font: { size: 16 } },
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) { return 'P/L: ' + new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(context.parsed.y); },
                                    title: function(context) { return 'Stock Price: ' + new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(context[0].label); }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af', callback: function(value) { return '€' + this.getLabelForValue(value); } }, title: { display: true, text: 'Stock Price at Expiration', color: '#9ca3af' } },
                            y: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af', callback: function(value) { return '€' + value; } }, title: { display: true, text: 'Profit / Loss', color: '#9ca3af' } }
                        }
                    }
                });
            } catch (e) {
                console.error("Failed to parse P/L chart data:", e);
            }
        }
    });
</script>
{% endblock %}